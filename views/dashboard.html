<!DOCTYPE html>
<html lang="uz">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Foydalanuvchi Kabineti</title>
  <link rel="stylesheet" href="../static/bootstrap-5.3.3-dist/css/bootstrap.min.css">
  <style>
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f5f6fa; margin:0; padding:0;}
    nav { background-color: #202c43; color:white; padding:1rem 1rem; display:flex; justify-content:space-between; align-items:center;}
    nav h3 { margin:0; font-size:1.2rem;}
    .logout { text-decoration:none; color:white; font-size:0.9rem;}
    .container { margin-top:1rem; max-width:95%; padding:0 0.5rem;}
    .card { padding:1rem; border-radius:1rem; background-color:#fff; box-shadow:0 5px 15px rgba(0,0,0,0.1); margin-bottom:1rem;}
    .card h4 { margin-bottom:0.8rem; font-size:1rem;}
    .form-control { margin-bottom:0.8rem; font-size:0.9rem;}
    .btn { font-size:0.9rem; padding:0.4rem 1rem;}
    .completed { text-decoration: line-through; color: #888;}

    .note-item {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      padding: 0.5rem 0.8rem;
      border: 1px solid #eee;
      border-radius: 0.5rem;
      margin-bottom: 0.5rem;
      background-color: #f9f9f9;
      word-break: break-word;
    }
    .note-left {
      display: flex;
      flex-direction: column;
      gap: 0.3rem;
    }
    .note-body { font-size:0.9rem; }
    .note-actions {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
    }
    .note-actions button, .note-actions a { font-size:0.8rem; padding:0.3rem 0.5rem; }

    img.note-img {
      max-width: 100%;
      border-radius:10px;
      margin-top:5px;
    }

    /* Desktop uchun */
    @media(min-width:576px){
      .note-item { flex-direction: row; justify-content: space-between; align-items: flex-start; }
      .note-left { flex-direction: row; align-items: center; gap:0.5rem;}
    }
    .note-item {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      padding: 0.5rem 0.8rem;
      border: 1px solid #eee;
      border-radius: 0.5rem;
      margin-bottom: 0.5rem;
      background-color: #f9f9f9;
      word-break: break-word;
    }

    /* Desktop (768px+) */
    @media (min-width:768px){
      .note-item {
        flex-direction: row;
        justify-content: space-between;
        align-items: flex-start;
      }
      .note-left {
        display: flex;
        align-items: center;
        gap: 1rem;
        flex: 1;
      }
      .note-body {
        font-size: 1rem;
      }
      img.note-img {
        max-width: 200px;
        height: auto;
      }
      .note-actions {
        display: flex;
        gap: 0.5rem;
        align-items: center;
      }
    }
    .note-item {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      background: #f8f9fa;
      border-radius: 10px;
      padding: 12px;
      margin-bottom: 12px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .note-img {
      max-width: 120px;
      border-radius: 8px;
      margin-top: 8px;
    }
    .note-actions {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .btn {
      padding: 6px 10px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
    }
    .btn-danger { background-color: #dc3545; color: #fff; }
    .btn-secondary { background-color: #6c757d; color: #fff; }
    .btn-success { background-color: #28a745; color: #fff; }
    .btn:hover { opacity: 0.9; }
  </style>
</head>
<body>
<nav>
  <h3>Foydalanuvchi Kabineti</h3>
  <a href="/logout" class="logout">Chiqish</a>
</nav>

<div class="container">

  <!-- Yangi Ma'lumot Qo'shish -->
  <div class="card">
    <h4>Yangi Ma'lumot Qo'shish</h4>
    <form id="addNoteForm" action="/dashboard/{{.UserId}}" method="post">
      <textarea name="about" placeholder="Yangi ma'lumot" class="form-control"></textarea>
      <button type="submit" class="btn btn-primary">Saqlash</button>
    </form>
  </div>

  <!-- Rasm qo‚Äòshish -->
  <div class="card">
    <h4>Rasm Qo‚Äòshish</h4>
    <form id="addImageForm" action="/dashboard/{{.UserId}}" method="post" enctype="multipart/form-data">
      <input type="file" name="image" accept="image/*" class="form-control" required>
      <button type="submit" class="btn btn-success">Rasmni yuklash</button>
    </form>
  </div>

  <!-- Barcha Ma'lumotlar -->
  <div class="card" id="notesContainer">
    <h4>Barcha Ma'lumotlar</h4>
    {{range .User.Notes}}
    <div class="note-item">
      <div class="note-left">
        <span class="note-body {{if .Completed}}completed{{end}}">{{.Body}}</span>
        {{if .ImagePath}}
        <img src="/{{.ImagePath}}" alt="Rasm" class="note-img">
        {{end}}
      </div>

      <div class="note-actions">
        <a href="/note/delete/{{.ID}}" class="btn btn-danger note-delete" data-id="{{.ID}}">üóëÔ∏è</a>
        <button class="btn btn-secondary note-copy" data-id="{{.ID}}">üìã</button>

        {{if .ImagePath}}
        <a href="/{{.ImagePath}}" download class="btn btn-success note-download">üì•</a>
        {{end}}
      </div>
    </div>
    {{else}}
    <p>Hozircha ma‚Äôlumot yo‚Äòq.</p>
    {{end}}
  </div>
</div>

<script>
  const notesContainer = document.getElementById('notesContainer');

  // Add Image
  document.getElementById("addImageForm").addEventListener("submit", async function(e) {
    e.preventDefault();
    const form = this;
    const formData = new FormData(form);
    const btn = form.querySelector("button");
    btn.disabled = true;
    btn.textContent = "Yuklanmoqda...";
    try {
      const res = await fetch(form.action, { method: "POST", body: formData });
      const data = await res.json();
      if (data.ImagePath) {
        const noteHTML = `
        <div class="note-item">
          <div class="note-left">
            <input type="checkbox" class="note-checkbox" data-id="${data.ID}">
            <span class="note-body">${data.Body || ""}</span>
            <img src="/${data.ImagePath}" alt="Rasm" class="note-img">
          </div>
          <div class="note-actions">
            <a href="/note/delete/${data.ID}" class="btn btn-danger note-delete" data-id="${data.ID}">O‚Äòchirish</a>
            <button class="btn btn-secondary note-copy" data-id="${data.ID}">üìã</button>
          </div>
        </div>`;
        notesContainer.insertAdjacentHTML("beforeend", noteHTML);
      } else { alert("Rasm yuklanmadi yoki xato yuz berdi."); }
    } catch (err) { alert("Xatolik: " + err.message); }
    btn.disabled = false;
    btn.textContent = "Rasmni yuklash";
    form.reset();
    initCheckboxes();
    initDeleteButtons();
    initCopyButtons();
  });

  // Checkbox toggle
  function initCheckboxes() {
    document.querySelectorAll('.note-checkbox').forEach(chk => {
      chk.onchange = function() {
        const noteId = this.dataset.id;
        fetch('/note/toggle/' + noteId, { method: 'POST' })
                .then(res => { if(res.ok){ this.nextElementSibling.classList.toggle('completed'); }});
      };
    });
  }

  // Delete button
  function initDeleteButtons() {
    document.querySelectorAll('.note-delete').forEach(btn => {
      btn.onclick = function(e){
        e.preventDefault();
        const noteId = this.dataset.id;
        fetch('/note/delete/' + noteId, { method: 'POST' })
                .then(res => { if(res.ok){ this.closest('.note-item').remove(); }});
      };
    });
  }

  // Copy button
  function initCopyButtons() {
    document.querySelectorAll('.note-copy').forEach(btn => {
      btn.onclick = function() {
        const noteItem = this.closest('.note-item');
        const text = noteItem.querySelector('.note-body').innerText;
        navigator.clipboard.writeText(text).then(() => {
          alert("Matn nusxalandi ‚úÖ");
        }).catch(err => { alert("Xatolik yuz berdi ‚ùå"); });
      };
    });
  }

  // Add Note
  document.getElementById('addNoteForm').addEventListener('submit', function(e){
    e.preventDefault();
    const body = this.about.value.trim();
    if(!body) return;
    fetch(this.action, {
      method: 'POST',
      headers: {'Content-Type':'application/x-www-form-urlencoded'},
      body: new URLSearchParams({ about: body })
    }).then(res => res.json())
            .then(data => {
              if(data.ID){
                const newNoteHTML = `
          <div class="note-item">
            <div class="note-left">
              <input type="checkbox" class="note-checkbox" data-id="${data.ID}">
              <span class="note-body">${data.Body}</span>
            </div>
            <div class="note-actions">
              <a href="/note/delete/${data.ID}" class="btn btn-danger note-delete" data-id="${data.ID}">O‚Äòchirish</a>
              <button class="btn btn-secondary note-copy" data-id="${data.ID}">üìã</button>
            </div>
          </div>`;
                notesContainer.insertAdjacentHTML('afterbegin', newNoteHTML);
                this.reset();
                initCheckboxes();
                initDeleteButtons();
                initCopyButtons();
              } else { alert(data.error || "Xatolik yuz berdi"); }
            });
  });

  // Init all
  initCheckboxes();
  initDeleteButtons();
  initCopyButtons();
</script>

</body>
</html>
